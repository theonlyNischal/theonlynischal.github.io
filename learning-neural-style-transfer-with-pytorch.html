<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <title>Learning Neural Style Transfer with PyTorch
 | Nischal Lal Shrestha</title>
      <meta property='og:type' content='website'>
      <meta property='og:locale' content='en_US'>
      <meta property='wagtail:language' content='en'>
      <link rel="alternate" type="application/rss+xml" href="/en/blog/rss/" />
      <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Learning Neural Style Transfer with PyTorch, Published On:Wed, Jan 19 2022, keywords: pytorch, neural style transfer, style transfer, [<Tag 'code'>, <Tag 'pytorch'>]">
    <meta name="keywords" content="pytorch, neural style transfer, style transfer, [<Tag 'code'>, <Tag 'pytorch'>]" />
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Learning Neural Style Transfer with PyTorch">
    <meta property="og:description" content="Neural Style Transfer is a technique to transfer the style of one image to another image. The idea is to create a new image that is similar to the content image but with the style of the style image.">
    <meta property="og:url" content="https://nischal.info.np/learning-neural-style-transfer-with-pytorch">
    <meta property="og:image" content="https://nischal.info.np/theme/img/code/Bouddha_style_transfer.png">
    <meta property="og:site_name" content="Nischal Lal Shrestha">
    <!-- Markup for Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@dakkulanthu">
    <meta name="twitter:title" content="Learning Neural Style Transfer with PyTorch">
    <meta name="twitter:description" content="Neural Style Transfer is a technique to transfer the style of one image to another image. The idea is to create a new image that is similar to the content image but with the style of the style image.">
    <meta name="twitter:creator" content="@dakkulanthu">
    <meta name="twitter:image" content="https://nischal.info.np/theme/img/code/Bouddha_style_transfer.png">
    <meta name="google-site-verification" content="iEvAoBxEoIpSiA4IZmG1FN9E_kBBkq7453c8krLFbpY" />
    <meta name="ahrefs-site-verification" content="eb6c465128e0ba9eb3ff9730abec8b97b91f55db6ebadf734372fed79414e07c">
    <link rel="canonical" href="./learning-neural-style-transfer-with-pytorch.html" />
    
      <meta name="google-site-verification" content="D7k-r3fHm-XfJ9E7T1uZ5aqHJG2mx-0uUZFeBUDN2lY">
      <meta name="ga-identifier" content="UA-87658599-6">
      <meta name="gtm-identifier" content="GTM-MD3XGZ4">
      
      <script src="https://nischal.info.np/theme/js/protocol-base.js"></script>
      <script src="https://nischal.info.np/theme/js/protocol-support.js"></script>
      <script src="https://nischal.info.np/theme/js/protocol-utils.js"></script>
      <link rel="stylesheet" href="https://nischal.info.np/theme/uswds-2.11.2/css/uswds.min.css" />
      <link rel="stylesheet" href="https://nischal.info.np/theme/css/protocol.css">
      <link rel="stylesheet" href="https://nischal.info.np/theme/css/protocol-components.css">
      <link rel="stylesheet" href="https://nischal.info.np/theme/css/main.css">
      <link rel="stylesheet" href="https://nischal.info.np/theme/css/my-touch.css">
      <link rel="stylesheet" href="https://nischal.info.np/theme/css/pygments.css">
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,300,700,300i,800,900">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Zilla+Slab:300,400,600,700,300i">
      <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://nischal.info.np/theme/img/favicon.png">
      <link rel="icon" type="image/png" sizes="196x196" href="https://nischal.info.np/theme/img/favicon.png">
      <link rel="shortcut icon" href="https://nischal.info.np/theme/img/favicon.png">
      <link rel="canonical" href="https://nischal.info.np">
      <script src="https://nischal.info.np/theme/js/main.js"></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <link rel="stylesheet" href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
      <script src="https://nischal.info.np/theme/uswds-2.11.2/js/uswds-init.min.js"></script>

      <!-- Global site tag (gtag.js) - Google Analytics -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-3ZR069LM8Q"></script>
      <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-3ZR069LM8Q');
   </script>
   <!-- Google Adsense -->
   <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2612172848875712"
   crossorigin="anonymous"></script>
      
   </head>
   <body class="" id="view-blog-index">
      <div class="wrapper">
<div class="sticky-top d-print-none">
    <div class="primary-nav-container">
        <div class="wrapper-burger">
            <div class="menu-container">
                <div class="narrow-screen-menu hidden d-lg-none">
                <div class="narrow-screen-menu-background dark-theme">
                    <div class="narrow-screen-menu-container">
                        <div class="container" role="navigation">
                            <div class="row">
                                <div class="col">
                                    <div class="nav-links pt-3">
                                        <div><a class="" href="https://nischal.info.np">Home</a></div>
                                            <div><a  href="https://nischal.info.np/category/algorithm.html">Algorithm</a></div>

                                            <div><a class="active" href="https://nischal.info.np/category/code.html">Code</a></div>

                                            <div><a  href="https://nischal.info.np/category/open-source.html">Open Source</a></div>

                                            <div><a  href="https://nischal.info.np/category/thoughts.html">Thoughts</a></div>

                                            <br>
<div class="row">
    <div class="col-12">
        <hr class="intro-and-content-divider">
    </div>
</div>                                            <div><a  href="https://nischal.info.np/nischal.html"><i class="la-lg las la-user"></i>  About Me</a></div>
                                            <div><a  href="https://nischal.info.np/projects.html"><i class="la-lg las la-file-code"></i>  Projects</a></div>
                                            <div><a  href="https://nischal.info.np/contact.html"><i class="la-lg las la-phone-volume"></i> Contact</a></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                <nav class="container wide-screen-menu-container" title="main site navigation">
                <div class="row">
                    <div class="col">
                        <div class="d-flex flex-row justify-content-between">
                            <div id="primary-nav-links">
                                <div class="d-flex align-items-center flex-wrap">
                                    <button class="burger  d-lg-none ml-md-0 " aria-label="Open menu">
                                        <div class="burger-bar burger-bar-top"></div>
                                        <div class="burger-bar burger-bar-middle"></div>
                                        <div class="burger-bar burger-bar-bottom"></div>
                                    </button>
                                    <a class="logo text-hide" href="/" aria-label="Nischal Lal Shrestha">Nischal Lal Shrestha</a>
                                    <div class="wide-screen-menu">
                                        <div class="nav-links d-none d-lg-block">
                                                <a  href="https://nischal.info.np/category/algorithm.html">Algorithm</a>
                                                <a class="active" href="https://nischal.info.np/category/code.html">Code</a>
                                                <a  href="https://nischal.info.np/category/open-source.html">Open Source</a>
                                                <a  href="https://nischal.info.np/category/thoughts.html">Thoughts</a>
 
                                                <a id=""  class="primary-nav-special-link  no-underline" href="https://nischal.info.np/nischal.html" ><i class="la-lg las la-user"></i>  About Me</a>
                                            
                                                <a id=""  class="primary-nav-special-link  no-underline" href="https://nischal.info.np/projects.html" ><i class="la-lg las la-file-code"></i>  Projects</a>
                                                
                                                <a id=""  class="primary-nav-special-link  no-underline" href="https://nischal.info.np/contact.html"><i class="la-lg las la-phone-volume"></i>  Contact</a>
                                        </div>
                                        

                                    </div>
                                </div>
                            </div>
                            <!-- Right -->
                            <div class="d-flex align-items-center">

                            </div>
                            

                        </div>
                    </div>
                </div>
                </nav>
            </div>
        </div>
    </div>
</div>
         <header role="banner">
         </header>
         
         <main role="main" id="main-content" class="main-content">
            <div class="container">
              

    <div class="row">
        <div class="offset-lg-1 col-lg-1 py-4 py-md-5 text-center d-print-none">
            <div class="blog-sticky-side d-none d-lg-flex justify-content-lg-end">
            <div class="share-button-group-wrapper" data-version="mini" data-layout="stacked" data-share-text="Learning Neural Style Transfer with PyTorch" data-link="https://nischal.info.np/learning-neural-style-transfer-with-pytorch"></div>
            </div>
        </div>
        <div class="py-4 py-md-5 col-lg-8">
            <div class="cms ">
            <h1 class="h1-heading">Learning Neural Style Transfer with PyTorch</h1>
            <div class="blog-authors d-flex flex-wrap flex-column mb-4">
                <p class="body-small my-2">
                    By
                    <span><b><a href="https://nischal.info.np/author/nischal-lal-shrestha.html">Nischal Lal Shrestha</a></b></span>
                    | On Wed, Jan 19 2022
                    | Filed under <span class="usa-tag"><a href="https://nischal.info.np/category/code.html">Code</a></span>
                </p>
            </div>
            <div class="blog-body">
                <figure class="my-default">
                    <img src="https://nischal.info.np/theme/img/code/Bouddha_style_transfer.png" alt="Image for Learning Neural Style Transfer with PyTorch" class="w-100" />
                    <figcaption class="body-small d-block mt-2">
                        
                    </figcaption>
                </figure>
                <div class="rich-text">
                    <div class="section" id="what-is-neural-style-transfer">
<h2>What is Neural Style Transfer?</h2>
<p>Neural Style Transfer is a technique to transfer the style of one image to another image. The idea is to create a new image that is similar to the content image but with the style of the style image. The content image is usually a photograph taken by a photographer and the style image is a photograph of a particular style.</p>
<p>Neural Style Transfer includes 3 images: style image, content image and generated image. We take style of style image, apply it to the content of content image and generate a generated image which will have the content of content image but style of the style image.</p>
<p>By Content we mean Objects and their arrangement
By Style we mean Style, Colors, Textures
<a class="reference external" href="https://arxiv.org/pdf/1508.06576.pdf">Link to paper</a></p>
</div>
<div class="section" id="how">
<h2>How?</h2>
<p>To generate a generated image, we will start with an image full of noise. We will pass the noisy image through network and find out the activation after each convolution layer. Both content image and style image is also passed and their activation maps are also calculated. Then using those activation maps we find the content error and style error. The total error will be the linear combination of content and style error. Next we will change the pixel of generated image such that the total error decreases.</p>
</div>
<div class="section" id="which-model">
<h2>Which model?</h2>
<p>We will use pre-trained VGG19 Network to extract content from content image and style from style images. These pre-trained network are trained over very large datasets and for sufficient output labels. Literature have shown that they does excellent jobs of detecting textures, styles and other visual processing tasks. We will freeze the parameters of these trained network so they don't get update later.</p>
<p>These trained neural network will give activation maps after each convolution layer. Lower level activation maps will represent pixel to pixel representation while higher level activation maps will provide high level contents, objects and their arrangement. So to find the content we must see the output from higher level activation maps.</p>
</div>
<div class="section" id="challenge">
<h2>Challenge</h2>
<p>The main challenge here is to capture the style of style image. For that we will make a bold assumption that the activation maps produced after each convolution layer characterize the style of style image. The idea is not to use the activation map directly but producing a Gramian Matrix from the activation maps.</p>
<p>Let's say we have an activation map of depth 6, and spatial resolution of 8x8 i.e the activation map will be the size of 6x8x8 i.e there will be 6 8x8 activation map. To create a Gram Matrix we take pairs of each activation map such that first we will take pairs of 0 and 1, 0 and 2 ... 0 and 5, then 1 and 2, 1 and 3 ... 1 and 5, then 2 and 3, 2 and 4, 2 and 5, then 3 and 4, 3 and 5, then 4 and 5. We multiply each activation map pair element wise and add them together. The added value is placed on the position according to filter count i.e if we take pair 0 and 1, then the added result is placed at postion 0 and 1 of a Gram Matrix. Also 0 and 1, and 1 and 0 will have the same value. The reason why Gram Matrix does a fantastic job of capturing style of style image is not really known and the paper also doesn't clearly mention how the author came up with this idea. One argument could be that Gram Matrix will have larger value in those position where the filters overlap. So if the Gram Matrix have larger value then the pair of filters are activated by the same inputs.</p>
<p>As mentioned earlier, we mostly start with white noise image but for this tutorial we will clone the content image as the generated image starter instead of white noise.</p>
<p><a class="reference external" href="https://colab.research.google.com/drive/1E5HhkgcS9PTGhORnr38x2Qr0Ytyj4qeE?usp=sharing">Follow on Google Colab</a></p>
<div class="highlight"><pre><span></span><span class="c1"># import resources</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span><span class="p">,</span> <span class="n">models</span>
</pre></div>
<p>Neural Network consists of two part. Features and Classifier. For this task we only need Features.</p>
<div class="highlight"><pre><span></span><span class="n">vgg</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">vgg19</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">features</span>
</pre></div>
<p>freeze all VGG parameters since we're only optimizing the target image.</p>
<div class="highlight"><pre><span></span><span class="c1"># freeze all VGG parameters since we&#39;re only optimizing the target image</span>
<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">vgg</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
    <span class="n">param</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
<p>Move the model to GPU, if available</p>
<div class="highlight"><pre><span></span><span class="c1"># move the model to GPU, if available</span>
<span class="n">train_on_gpu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>

<span class="k">if</span> <span class="n">train_on_gpu</span><span class="p">:</span>
    <span class="n">vgg</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="load-image">
<h2>Load image</h2>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">max_size</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">shape</span>  <span class="c1"># makes sure style image is resized to content image</span>

    <span class="n">in_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">size</span><span class="p">),</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span>
                            <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">))</span>
    <span class="p">])</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">in_transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image</span>
</pre></div>
<p>Load in content and style image</p>
<div class="highlight"><pre><span></span><span class="c1"># load in content and style image</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s1">&#39;/content/meghraj-neupane-YtEzq-hnv5k-unsplash.jpg&#39;</span><span class="p">)</span>
<span class="c1"># Resize style to match content, makes code easier</span>
<span class="n">style</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s1">&#39;/content/autumn-studio-zv3ckJKftC4-unsplash.jpg&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">content</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>

<span class="k">if</span> <span class="n">train_on_gpu</span><span class="p">:</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</pre></div>
<p>Define helper functions for un-normalizing an image. Also convert it from a tensor image to a numpy image for display.</p>
<div class="highlight"><pre><span></span><span class="c1"># helper function for un-normalizing an image</span>
<span class="c1"># and converting it from a Tensor image to a NumPy image for display</span>
<span class="k">def</span> <span class="nf">im_convert</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Display a tensor as an image. &quot;&quot;&quot;</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">))</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image</span>
</pre></div>
<p>Display the images.</p>
<div class="highlight"><pre><span></span><span class="c1"># display the images</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="c1"># content and style ims side-by-side</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_convert</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_convert</span><span class="p">(</span><span class="n">style</span><span class="p">))</span>
</pre></div>
<img alt="Food is love for Nirdesh" src="theme/img/code/content_and_style.png" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>As discussed earlier, we get content and style from the activation maps of CNN. To do that we need to see the architecture of network we are going to use. Since we are using pre-trained VGG network. Let's see the archtiecture of VGG19.</p>
<img alt="Food is love for Nirdesh" src="theme/img/code/vgg19.png" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>VGG19 consist of 5 blocks of Convolution block, Let con1_1 be the first block the image pass through and conv5_1 be the fifth block the image passed through. Including max-pool and relu, the position of these 5 blocks in above trained cnn is 0, 5, 10, 19, 28. Also we will take content from position conv4_2. conv4_2 is higher enough to include higher level content invariant of position.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_features</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="s2">&quot;conv1_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;5&quot;</span><span class="p">:</span> <span class="s2">&quot;conv2_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;10&quot;</span><span class="p">:</span> <span class="s2">&quot;conv3_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;19&quot;</span><span class="p">:</span> <span class="s2">&quot;conv4_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;21&quot;</span><span class="p">:</span> <span class="s2">&quot;conv4_2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;28&quot;</span><span class="p">:</span> <span class="s2">&quot;conv5_1&quot;</span>
        <span class="p">}</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">image</span>

    <span class="c1"># model._modules is a dictionary holding each module in the model.</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="n">features</span><span class="p">[</span><span class="n">layers</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">features</span>

<span class="k">def</span> <span class="nf">gram_matrix</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Calculate the Gram Matrix of a given tensor</span>
<span class="sd">        Gram Matrix: https://en.wikipedia.org/wiki/Gramian_matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get the batch_size, depth, height, and width of the Tensor</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

    <span class="c1"># reshape so we&#39;re multiplying the features for each channel</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>

    <span class="c1"># calculate the gram matrix</span>
    <span class="n">gram</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">tensor</span><span class="o">.</span><span class="n">t</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">gram</span>
</pre></div>
<p>Get content and style features only once before training.</p>
<div class="highlight"><pre><span></span><span class="c1"># get content and style features only once before training</span>
<span class="n">content_features</span> <span class="o">=</span> <span class="n">get_features</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">vgg</span><span class="p">)</span>
<span class="n">style_features</span> <span class="o">=</span> <span class="n">get_features</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="n">vgg</span><span class="p">)</span>

<span class="c1"># calculate the gram matrices for each layer of our style representation</span>
<span class="n">style_grams</span> <span class="o">=</span> <span class="p">{</span><span class="n">layer</span><span class="p">:</span> <span class="n">gram_matrix</span><span class="p">(</span><span class="n">style_features</span><span class="p">[</span><span class="n">layer</span><span class="p">])</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">style_features</span><span class="p">}</span>

<span class="c1"># create a third &quot;target&quot; image and prep it for change</span>
<span class="c1"># it is a good idea to start off with the target as a copy of our *content* image</span>
<span class="c1"># then iteratively change its style</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="n">train_on_gpu</span><span class="p">:</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="c1"># weights for each style layer</span>
<span class="c1"># weighting earlier layers more will result in *larger* style artifacts</span>
<span class="c1"># notice we are excluding `conv4_2` our content representation</span>
<span class="n">style_weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;conv1_1&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s1">&#39;conv2_1&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s1">&#39;conv3_1&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                <span class="s1">&#39;conv4_1&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                <span class="s1">&#39;conv5_1&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>

<span class="n">content_weight</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># alpha</span>
<span class="n">style_weight</span> <span class="o">=</span> <span class="mf">1e3</span>  <span class="c1"># beta</span>

<span class="c1"># for displaying the target image, intermittently</span>
<span class="n">show_every</span> <span class="o">=</span> <span class="mi">300</span>

<span class="c1"># iteration hyperparameters</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">([</span><span class="n">target</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.003</span><span class="p">)</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">5000</span>  <span class="c1"># decide how many iterations to update your image (5000)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

    <span class="c1"># get the features from your target image</span>
    <span class="n">target_features</span> <span class="o">=</span> <span class="n">get_features</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">vgg</span><span class="p">)</span>

    <span class="c1"># the content loss</span>
    <span class="n">content_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">target_features</span><span class="p">[</span><span class="s1">&#39;conv4_2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">content_features</span><span class="p">[</span><span class="s1">&#39;conv4_2&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># the style loss</span>
    <span class="c1"># initialize the style loss to 0</span>
    <span class="n">style_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># then add to it for each layer&#39;s gram matrix loss</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">style_weights</span><span class="p">:</span>
        <span class="c1"># get the &quot;target&quot; style representation for the layer</span>
        <span class="n">target_feature</span> <span class="o">=</span> <span class="n">target_features</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
        <span class="n">target_gram</span> <span class="o">=</span> <span class="n">gram_matrix</span><span class="p">(</span><span class="n">target_feature</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">target_feature</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># get the &quot;style&quot; style representation</span>
        <span class="n">style_gram</span> <span class="o">=</span> <span class="n">style_grams</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
        <span class="c1"># the style loss for one layer, weighted appropriately</span>
        <span class="n">layer_style_loss</span> <span class="o">=</span> <span class="n">style_weights</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">target_gram</span> <span class="o">-</span> <span class="n">style_gram</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># add to the style loss</span>
        <span class="n">style_loss</span> <span class="o">+=</span> <span class="n">layer_style_loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>

    <span class="c1"># calculate the *total* loss</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="n">content_weight</span> <span class="o">*</span> <span class="n">content_loss</span> <span class="o">+</span> <span class="n">style_weight</span> <span class="o">*</span> <span class="n">style_loss</span>

    <span class="c1"># update your target image</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">total_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="c1"># display intermediate images and print the loss</span>
    <span class="k">if</span>  <span class="n">ii</span> <span class="o">%</span> <span class="n">show_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total loss: &#39;</span><span class="p">,</span> <span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_convert</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;image_</span><span class="si">{}</span><span class="s2">.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>

                </div>
                <div class="share-button-group-wrapper mt-5 d-print-none" data-share-text="Learning Neural Style Transfer with PyTorch" data-link="https://nischal.info.np/learning-neural-style-transfer-with-pytorch"></div>
            </div>
            <br/>



            <div id="disqus_thread"></div>
                <script>
                    /**
                    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
                    */
                    /*
                    var disqus_config = function () {
                        this.page.url = https://nischal.info.np;  // Replace PAGE_URL with your page's canonical URL variable
                        this.page.identifier = learning-neural-style-transfer-with-pytorch; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                    };
                    */
                    (function() {  // DON'T EDIT BELOW THIS LINE
                        var d = document, s = d.createElement('script');
                        
                        s.src = 'https://shresthanischal.disqus.com/embed.js';
                        
                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
                            
            </div>
        </div>
    </div>

               
            </div>
         </main>



<footer class="mzp-c-footer">
	<div class="mzp-l-content ">
		<nav class="mzp-c-footer-primary">
			<div class="mzp-c-footer-primary-logo">
				<a href="https://nischal.info.np">Nischal Lal Shrestha</a>
			</div>
			<div class="mzp-c-footer-sections">
				<section class="mzp-c-footer-section">
					<h5 class="mzp-c-footer-heading">
    Explore
  </h5>
					<ul class="mzp-c-footer-list">
							<li><a href="https://nischal.info.np/category/algorithm.html">Algorithm</a></li>
							<li><a href="https://nischal.info.np/category/code.html">Code</a></li>
							<li><a href="https://nischal.info.np/category/open-source.html">Open Source</a></li>
							<li><a href="https://nischal.info.np/category/thoughts.html">Thoughts</a></li>
					</ul>
				</section>
				<section class="mzp-c-footer-section">
					<h5 class="mzp-c-footer-heading">
    About
  </h5>
					<ul class="mzp-c-footer-list">
                        <li><a href="https://nischal.info.np/nischal.html">About Me</a></li>
                        <li><a href="https://nischal.info.np/projects.html">Projects</a></li>
                        <li><a href="https://nischal.info.np/contact.html">Contact</a></li>
					</ul>
				</section>
				<section class="mzp-c-footer-section">
					<h5 class="mzp-c-footer-heading">
    Website Credits
  </h5>
					<ul class="mzp-c-footer-list">
						<li><a href="https://protocol.mozilla.org/" rel="nofollow">Mozilla Protocol</a></li>
						<li><a href="https://designsystem.digital.gov/how-to-use-uswds/" rel="nofollow">
							USWD </a></li>
						<li><a href="https://docs.getpelican.com/en/stable/index.html" rel="nofollow">Pelican</a></li>
						<li><a href="https://icons8.com/line-awesome" rel="nofollow">Line Awesome</a></li>
						<li><a href="https://pages.github.com/" rel="nofollow">Github Pages</a></li>
						<li><a href="https://unsplash.com/" rel="nofollow">Unsplash</a></li>
					</ul>
				</section>
			</div>
		</nav>
		<nav class="mzp-c-footer-secondary">
			<ul class="mzp-c-footer-links-social">
				<li>
					<a class="twitter" href="https://twitter.com/dakkulanthu" rel="nofollow">Twitter
						<span> (@dakkulanthu)</span>
					</a>
				</li>
				<li>
					<a class="youtube" href="https://www.youtube.com/channel/UCQoieW45COakbskXxW_ANIw" rel="nofollow">YouTube
						<span> (Nischal Lal Shrestha)</span>
					</a>
				</li>
			</ul>

			<div class="mzp-c-footer-legal">
				<p class="mzp-c-footer-license">Hey there, I'm Nischal.
						<br/>
						I am a student, a developer. Currently learning ML, DL, Data Science, Python.
				</p>

				<p class="mzp-c-footer-license">I love Everything that makes me more Human.
				<br/>
				<br/>
				 While not Coding, I play Football and Chess.
				</p class="mzp-c-footer-license">

				<p mzp-c-footer-license>Copyright text 2020 by Nischal!!</p>
				
				<ul class="mzp-c-footer-terms">
				<li><a href="https://nischal.info.np/cookies.html">Cookies</a></li>
				<li><a href="https://nischal.info.np/privacy.html">Privacy Policy</a></li>
				<li><a href="https://nischal.info.np/disclaimer.html">Disclaimer</a></li>
				<li><a href="https://nischal.info.np/code-of-conduct.html">Code of Conduct</a></li>
				
				</ul>
      		</div>

		</nav>
	</div>
</footer>      </div>
      <script src="https://nischal.info.np/theme/uswds-2.11.2/js/uswds.min.js"></script>
      <script src="https://nischal.info.np/theme/js/main.js"></script>
   </body>
</html>
